{
  "active": true,
  "connections": {
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LoopOverItems": {
      "main": [
        [],
        [
          {
            "node": "Call 'My workflow 2'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "LoopOverItems",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'My workflow 2'": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Results": {
      "main": [
        [
          {
            "node": "LoopOverItems",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger 1/Week/Sun": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-11-06T03:12:24.502Z",
  "id": "wH0dkSQYG5ytMNCj",
  "isArchived": false,
  "meta": null,
  "name": "UpdateServers",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "48863004-a323-48e9-b0b7-bcaf58ab8ea8",
              "name": "ips",
              "value": "[\"10.0.0.201\", \"10.0.0.202\", \"10.0.0.203\", \"10.0.0.204\", \"10.0.0.205\", \"10.0.0.206\", \"10.0.0.207\" ]",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        192,
        0
      ],
      "id": "17604237-3a1e-4684-9bf5-6d2ebb2af0c4",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        928,
        32
      ],
      "id": "14ebc04e-afa2-44da-a177-bb0ce326cd4b",
      "name": "LoopOverItems",
      "executeOnce": false
    },
    {
      "parameters": {
        "fieldToSplitOut": "ips",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        416,
        0
      ],
      "id": "8cc0bf4c-b878-4819-8ec4-5a45388163fd",
      "name": "Split Out"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "VCdlQdIQp6H4QPNg",
          "mode": "list",
          "cachedResultUrl": "/workflow/VCdlQdIQp6H4QPNg",
          "cachedResultName": "update machines"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "ip_address": "={{ $json.ips }}"
          },
          "matchingColumns": [
            "ip_address"
          ],
          "schema": [
            {
              "id": "ip_address",
              "displayName": "ip_address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        1216,
        48
      ],
      "id": "c02e18c9-a803-4fcc-9b6f-eadfec9e4379",
      "name": "Call 'My workflow 2'"
    },
    {
      "parameters": {
        "jsCode": "// Helper function to convert MB to human readable\nfunction formatBytes(mb) {\n  if (!mb || isNaN(mb)) return 'N/A';\n  if (mb >= 1024) {\n    return (mb / 1024).toFixed(2) + ' GB';\n  }\n  return mb + ' MB';\n}\n\n// Helper function to create progress bar\nfunction createProgressBar(percent, length = 10) {\n  if (!percent || isNaN(percent)) return 'â–‘'.repeat(length);\n  const filled = Math.round((percent / 100) * length);\n  const empty = length - filled;\n  return 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(empty);\n}\n\n// Helper function to safely get value\nfunction safeValue(val, defaultVal = 'N/A') {\n  return (val !== undefined && val !== null) ? val : defaultVal;\n}\n\n// Get the current IP\nconst currentIp = $('Prepare Commands1').first().json.ip\n\n// Collect all command results for this IP\nconst result = {\n  ip: currentIp,\n  timestamp: new Date().toISOString(),\n  resources: {},\n  summary: '',\n  discord_embed: {}\n};\n\n// Process each command result\nfor (const item of $input.all()) {\n  console.log('Processing item:', JSON.stringify(item.json, null, 2));\n  \n  // Try to get command name from different possible properties\n  const commandName = item.json.command_name || item.json.command || item.json.type || item.json.resource_type;\n  \n  console.log('Command name:', commandName);\n  \n  // Check if data is in stdout or directly in json\n  let parsedData;\n  if (item.json.stdout) {\n    try {\n      parsedData = JSON.parse(item.json.stdout);\n    } catch (error) {\n      parsedData = {\n        error: 'Failed to parse output',\n        raw_output: item.json.stdout\n      };\n    }\n  } else {\n    // Data might be directly in the json object\n    parsedData = item.json;\n  }\n  \n  // Detect resource type from data structure if command_name is missing\n  let detectedType = commandName;\n  if (!detectedType) {\n    if (parsedData.cpu_count !== undefined) detectedType = 'cpu';\n    else if (parsedData.total_mb !== undefined) detectedType = 'memory';\n    else if (parsedData.total_gb !== undefined) detectedType = 'storage';\n  }\n  \n  console.log('Detected type:', detectedType);\n  \n  if (detectedType) {\n    result.resources[detectedType] = parsedData;\n  }\n}\n\nconsole.log('Final resources:', JSON.stringify(result.resources, null, 2));\n\n// Format memory data\nif (result.resources.memory && result.resources.memory.total_mb) {\n  const mem = result.resources.memory;\n  mem.free_percent = ((mem.free_mb / mem.total_mb) * 100).toFixed(1);\n  mem.available_percent = ((mem.available_mb / mem.total_mb) * 100).toFixed(1);\n  mem.used_percent = (100 - parseFloat(mem.free_percent)).toFixed(1);\n  \n  mem.total_human = formatBytes(mem.total_mb);\n  mem.used_human = formatBytes(mem.used_mb);\n  mem.free_human = formatBytes(mem.free_mb);\n  mem.available_human = formatBytes(mem.available_mb);\n}\n\n// Format storage data\nif (result.resources.storage) {\n  const storage = result.resources.storage;\n  storage.use_percent_num = parseFloat(storage.use_percent);\n}\n\n// Format CPU data\nif (result.resources.cpu) {\n  const cpu = result.resources.cpu;\n  cpu.used_percent = parseFloat(cpu.cpu_used_percent).toFixed(1);\n  cpu.idle_percent = parseFloat(cpu.cpu_idle_percent).toFixed(1);\n  cpu.cores = cpu.cpu_count;\n}\n\n// Create Discord-formatted summary\nconst tick3 = '```';\nlet summary = '';\nsummary += `**ðŸ–¥ï¸ Server Resources: \\`${currentIp}\\`**\\n`;\nsummary += `*Last checked: ${new Date().toLocaleString()}*\\n\\n`;\n\nif (result.resources.cpu) {\n  const cpu = result.resources.cpu;\n  const usedPercent = parseFloat(cpu.used_percent) || 0;\n  summary += `**ðŸ’» CPU**\\n`;\n  summary += tick3 + '\\n';\n  summary += `Cores:     ${safeValue(cpu.cores)}\\n`;\n  summary += `Usage:     ${safeValue(cpu.used_percent, '0')}%\\n`;\n  summary += `Progress:  ${createProgressBar(usedPercent)} ${safeValue(cpu.used_percent, '0')}%\\n`;\n  summary += tick3 + '\\n';\n}\n\nif (result.resources.memory) {\n  const mem = result.resources.memory;\n  const usedPercent = parseFloat(mem.used_percent) || 0;\n  summary += `**ðŸ§  Memory**\\n`;\n  summary += tick3 + '\\n';\n  summary += `Total:     ${mem.total_human}\\n`;\n  summary += `Used:      ${mem.used_human} (${mem.used_percent}%)\\n`;\n  summary += `Free:      ${mem.free_human} (${mem.free_percent}%)\\n`;\n  summary += `Available: ${mem.available_human}\\n`;\n  summary += `Progress:  ${createProgressBar(usedPercent)} ${mem.used_percent}%\\n`;\n  summary += tick3 + '\\n';\n}\n\nif (result.resources.storage) {\n  const storage = result.resources.storage;\n  const usedPercent = storage.use_percent_num || 0;\n  summary += `**ðŸ’¾ Storage (Root)**\\n`;\n  summary += tick3 + '\\n';\n  summary += `Total:     ${safeValue(storage.total_gb)}\\n`;\n  summary += `Used:      ${safeValue(storage.used_gb)} (${safeValue(storage.use_percent)})\\n`;\n  summary += `Available: ${safeValue(storage.available_gb)}\\n`;\n  summary += `Progress:  ${createProgressBar(usedPercent)} ${safeValue(storage.use_percent)}\\n`;\n  summary += tick3 + '\\n';\n}\n\nresult.summary = summary;\n\nresult.discord_embed = {\n  embeds: [{\n    title: `ðŸ–¥ï¸ Server: ${currentIp}`,\n    description: summary,\n    color: result.resources.cpu && parseFloat(result.resources.cpu.used_percent) > 80 ? 15158332 : 3447003,\n    timestamp: new Date().toISOString(),\n    footer: {\n      text: \"Server Resource Monitor\"\n    }\n  }]\n};\n\nreturn [{ json: result }];"
      },
      "id": "1be0dfd5-72a1-4a64-9d70-b777230e1104",
      "name": "Aggregate Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1440,
        48
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ],
      "id": "290b5345-0bd7-49b7-9fd2-1f548115d58b",
      "name": "Trigger 1/Week/Sun"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2025-11-06T03:12:24.502Z",
      "createdAt": "2025-11-06T03:12:24.502Z",
      "role": "workflow:owner",
      "workflowId": "wH0dkSQYG5ytMNCj",
      "projectId": "9tVnjhoqECLAKTN1"
    }
  ],
  "staticData": {
    "node:Trigger 1/Week/Sun": {
      "recurrenceRules": []
    }
  },
  "tags": [
    {
      "updatedAt": "2025-11-06T03:12:34.025Z",
      "createdAt": "2025-11-06T03:12:34.025Z",
      "id": "IwoPCDtQyVJy4UoS",
      "name": "update"
    },
    {
      "updatedAt": "2025-11-06T03:11:50.434Z",
      "createdAt": "2025-11-06T03:11:50.434Z",
      "id": "vgqvVrZ3n7HfHOM7",
      "name": "main"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-11-06T03:15:02.552Z",
  "versionId": "ea28690c-7aeb-4a53-8ad3-7e1b706bc083"
}